name: Epic Algo Library CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Node.js Pipeline (auto-detect)
      # -----------------------------
      - name: Detect Node project
        id: node_detect
        run: |
          if [ -f "package.json" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.node_detect.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Node dependencies
        if: steps.node_detect.outputs.found == 'true'
        run: npm install

      - name: Run Node tests
        if: steps.node_detect.outputs.found == 'true'
        run: npm test --if-present

      # -----------------------------
      # Python Pipeline (auto-detect)
      # -----------------------------
      - name: Detect Python project
        id: py_detect
        run: |
          if [ -f "requirements.txt" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.py_detect.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        if: steps.py_detect.outputs.found == 'true'
        run: pip install -r requirements.txt

      - name: Run Python tests
        if: steps.py_detect.outputs.found == 'true'
        run: pytest || echo "No Python tests found"

      # -----------------------------
      # .es Artifact Validation
      # -----------------------------
      - name: Validate .es artifacts
        run: |
          echo "Validating .es artifacts..."
          shopt -s nullglob
          files=( **/*.es )
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .es files found."
            exit 0
          fi

          for file in "${files[@]}"; do
            echo "Checking $file"
            # Replace this with your real validator when ready
            if ! grep -q "artifact" "$file"; then
              echo "::error file=$file::Invalid .es structure"
              exit 1
            fi
          done

      # -----------------------------
      # Build Step (optional)
      # -----------------------------
      - name: Build project
        run: |
          echo "Running build step..."
          if [ -f "package.json" ]; then
            npm run build --if-present
          elif [ -f "Makefile" ]; then
            make
          else
            echo "No build step defined."
          fi

      # -----------------------------
      # CI Summary
      # -----------------------------
      - name: Summary
        run: echo "Epic Algo Library CI completed successfully."
